<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EquiRound - Patient Monitor Allocator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- GLOBAL STYLES --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        
        /* --- COMPONENTS --- */
        .card { background: white; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .fade-in { animation: fadeIn 0.5s; }
        
        /* --- UTILITIES --- */
        .patient-list-scroll::-webkit-scrollbar { width: 6px; }
        .patient-list-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .patient-list-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .patient-list-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .timeline-line::before {
            content: '';
            position: absolute;
            top: 0; bottom: 0; left: 15px;
            width: 2px;
            background: #e2e8f0;
            z-index: 0;
        }

        .max-h-0 { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .max-h-96 { max-height: 24rem; overflow-y: auto; transition: max-height 0.3s ease-in; }

        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 12px;
            position: fixed;
            z-index: 50;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        #importModal { background-color: rgba(0,0,0,0.5); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="p-4 md:p-6 relative">

    <div class="max-w-full mx-auto">
        
        <!-- HEADER -->
        <header class="mb-8 flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded-lg shadow-sm border border-slate-200">
            <div class="text-center md:text-left mb-4 md:mb-0">
                <h1 class="text-2xl font-bold text-slate-800"><i class="fa-solid fa-heart-pulse text-red-500"></i> EquiRound</h1>
                <p class="text-slate-500 text-sm mt-1">Equitable Patient Monitor Allocator</p>
            </div>
            <button onclick="toggleImportModal()" class="bg-slate-700 text-white text-sm px-4 py-2 rounded shadow hover:bg-slate-800 transition">
                <i class="fa-solid fa-file-import mr-2"></i> Import Config
            </button>
        </header>

        <!-- MAIN CONFIG GRID -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <!-- COLUMN 1: CONFIG & DOCTORS -->
            <div class="space-y-6 lg:col-span-1">
                
                <!-- 1. SHIFT CONFIG -->
                <div class="card p-5 border-l-4 border-blue-500">
                    <!-- Renamed Header -->
                    <h2 class="text-xl font-bold mb-4 text-slate-700">1. Shift & Config</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Start Time</label>
                                <input type="time" id="startTime" value="17:00" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-300">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">End Time</label>
                                <input type="time" id="endTime" value="05:00" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-300">
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 p-3 rounded border border-blue-100 space-y-3">
                            <!-- Q2 -->
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <label class="block text-xs font-bold uppercase text-blue-600">Q2 First Check</label>
                                    <div class="text-[10px] text-blue-500" id="q2StartTimeDisplay">5:00 PM</div>
                                </div>
                                <select id="q2Offset" class="w-full p-1.5 text-xs border rounded focus:ring-2 focus:ring-blue-300" onchange="updateDuration()">
                                    <option value="0">Shift Start (+0h)</option>
                                    <option value="1">Hour 1 (+1h)</option>
                                </select>
                            </div>
                            
                            <!-- Q4 -->
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <label class="block text-xs font-bold uppercase text-blue-600">Q4 First Check</label>
                                    <div class="text-[10px] text-blue-500" id="q4StartTimeDisplay">5:00 PM</div>
                                </div>
                                <select id="q4Offset" class="w-full p-1.5 text-xs border rounded focus:ring-2 focus:ring-blue-300" onchange="updateDuration()">
                                    <option value="0">Shift Start (+0h)</option>
                                    <option value="1">Hour 1 (+1h)</option>
                                    <option value="2">Hour 2 (+2h)</option>
                                    <option value="3">Hour 3 (+3h)</option>
                                </select>
                            </div>

                            <!-- Q8 -->
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <label class="block text-xs font-bold uppercase text-blue-600">Q8 First Check</label>
                                    <div class="text-[10px] text-blue-500" id="q8StartTimeDisplay">5:00 PM</div>
                                </div>
                                <select id="q8Offset" class="w-full p-1.5 text-xs border rounded focus:ring-2 focus:ring-blue-300" onchange="updateDuration()">
                                    <option value="0">Shift Start (+0h)</option>
                                    <option value="1">Hour 1 (+1h)</option>
                                    <option value="2">Hour 2 (+2h)</option>
                                    <option value="3">Hour 3 (+3h)</option>
                                    <option value="4">Hour 4 (+4h)</option>
                                    <option value="5">Hour 5 (+5h)</option>
                                    <option value="6">Hour 6 (+6h)</option>
                                    <option value="7">Hour 7 (+7h)</option>
                                </select>
                            </div>
                        </div>

                        <div class="text-sm text-slate-500 font-semibold border-t pt-2" id="durationDisplay">Duration: 12 Hours</div>
                        
                        <!-- DISTRIBUTION LOGIC SLIDER -->
                        <div class="mt-4 pt-4 border-t border-slate-200">
                            <label class="block text-sm font-bold text-slate-700 mb-2">Distribution Logic</label>
                            <input type="range" id="equitySlider" min="0" max="100" value="100" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600" oninput="updateEquityDisplay()">
                            <div class="flex justify-between text-xs text-slate-500 mt-1">
                                <span>Equal Totals</span>
                                <span>Equal Density</span>
                            </div>
                            <div class="text-center text-xs font-semibold text-blue-600 mt-1" id="equityValueDisplay">Respect Availability: 100%</div>
                        </div>

                        <!-- CLUSTERING SLIDER -->
                        <div class="mt-4 pt-4 border-t border-slate-200">
                            <label class="block text-sm font-bold text-slate-700 mb-2">Location Clustering</label>
                            <input type="range" id="clusterSlider" min="0" max="100" value="15" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" oninput="updateClusterDisplay()">
                            <div class="flex justify-between text-xs text-slate-500 mt-1">
                                <span>0% Bonus</span>
                                <span>100% Bonus</span>
                            </div>
                            <div class="text-center text-xs font-semibold text-indigo-600 mt-1" id="clusterValueDisplay">Location Bonus: 15%</div>
                        </div>

                        <!-- TIME BLOCKING TOGGLE -->
                        <div class="mt-4 pt-4 border-t border-slate-200 flex flex-col gap-3">
                            <div class="flex items-center justify-between">
                                <div>
                                    <label class="text-sm font-bold text-slate-700 block">Time Blocking</label>
                                    <span class="text-[10px] text-slate-400">One doctor covers all patients per hour.</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="timeBlockingToggle" class="sr-only peer">
                                    <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            
                            <!-- STAGGER TOGGLE -->
                            <div class="flex items-center justify-between border-t border-slate-100 pt-3">
                                <div>
                                    <label class="text-sm font-bold text-slate-700 block">Stagger Schedule</label>
                                    <span class="text-[10px] text-slate-400">Distribute checks to smooth workload.</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="staggerToggle" class="sr-only peer">
                                    <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-teal-500"></div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. DOCTOR CONFIG -->
                <div class="card p-5 border-l-4 border-green-500">
                    <h2 class="text-xl font-bold mb-4 text-slate-700">2. Doctors & Availability</h2>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="newDocName" placeholder="New Doc Name..." class="flex-1 p-2 border rounded shadow-sm text-sm" onkeydown="if(event.key === 'Enter') addDoctor()">
                        <button onclick="addDoctor()" class="bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <div id="docList" class="space-y-3 max-h-[600px] overflow-y-auto patient-list-scroll pr-1"></div>
                </div>
            </div>

            <!-- COLUMN 2-4: PATIENTS & LOCATIONS -->
            <div class="lg:col-span-3 space-y-6">
                
                <!-- 3. PATIENT CATEGORIES -->
                <div class="h-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-slate-700">3. Patient Categories (Frequency)</h2>
                        <span class="text-sm bg-purple-100 text-purple-800 py-1 px-3 rounded-full font-bold" id="patientCountBadge">0 Patients</span>
                    </div>
                    <!-- FREQUENCY COLUMNS -->
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
                        <!-- Q1 -->
                        <div class="bg-red-50 border border-red-200 rounded-lg flex flex-col h-80">
                            <div class="p-3 bg-red-100 border-b border-red-200 rounded-t-lg">
                                <h3 class="font-bold text-red-800 flex justify-between items-center">Q1 (Hourly) <span class="text-xs bg-white text-red-600 px-2 py-0.5 rounded-full" id="count-q1">0</span></h3>
                                <div class="mt-2"><textarea id="input-q1" rows="2" placeholder="Paste names here..." class="w-full text-sm p-2 border border-red-200 rounded focus:ring-2 focus:ring-red-400 focus:outline-none resize-none" onkeydown="handlePatientInput(event, 1)"></textarea></div>
                            </div>
                            <div class="flex-1 overflow-y-auto p-2 space-y-2 patient-list-scroll" id="list-q1"></div>
                        </div>
                        <!-- Q2 -->
                        <div class="bg-orange-50 border border-orange-200 rounded-lg flex flex-col h-80">
                            <div class="p-3 bg-orange-100 border-b border-orange-200 rounded-t-lg">
                                <h3 class="font-bold text-orange-800 flex justify-between items-center">Q2 (Every 2h) <span class="text-xs bg-white text-orange-600 px-2 py-0.5 rounded-full" id="count-q2">0</span></h3>
                                <div class="mt-2"><textarea id="input-q2" rows="2" placeholder="Paste names here..." class="w-full text-sm p-2 border border-orange-200 rounded focus:ring-2 focus:ring-orange-400 focus:outline-none resize-none" onkeydown="handlePatientInput(event, 2)"></textarea></div>
                            </div>
                            <div class="flex-1 overflow-y-auto p-2 space-y-2 patient-list-scroll" id="list-q2"></div>
                        </div>
                        <!-- Q4 -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg flex flex-col h-80">
                            <div class="p-3 bg-blue-100 border-b border-blue-200 rounded-t-lg">
                                <h3 class="font-bold text-blue-800 flex justify-between items-center">Q4 (Every 4h) <span class="text-xs bg-white text-blue-600 px-2 py-0.5 rounded-full" id="count-q4">0</span></h3>
                                <div class="mt-2"><textarea id="input-q4" rows="2" placeholder="Paste names here..." class="w-full text-sm p-2 border border-blue-200 rounded focus:ring-2 focus:ring-blue-400 focus:outline-none resize-none" onkeydown="handlePatientInput(event, 4)"></textarea></div>
                            </div>
                            <div class="flex-1 overflow-y-auto p-2 space-y-2 patient-list-scroll" id="list-q4"></div>
                        </div>
                        <!-- Q8 -->
                        <div class="bg-green-50 border border-green-200 rounded-lg flex flex-col h-80">
                            <div class="p-3 bg-green-100 border-b border-green-200 rounded-t-lg">
                                <h3 class="font-bold text-green-800 flex justify-between items-center">Q8 (Every 8h) <span class="text-xs bg-white text-green-600 px-2 py-0.5 rounded-full" id="count-q8">0</span></h3>
                                <div class="mt-2"><textarea id="input-q8" rows="2" placeholder="Paste names here..." class="w-full text-sm p-2 border border-green-200 rounded focus:ring-2 focus:ring-green-400 focus:outline-none resize-none" onkeydown="handlePatientInput(event, 8)"></textarea></div>
                            </div>
                            <div class="flex-1 overflow-y-auto p-2 space-y-2 patient-list-scroll" id="list-q8"></div>
                        </div>
                    </div>
                </div>

                <!-- 4. LOCATION CONFIG -->
                <div class="card p-5 border-l-4 border-indigo-500">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-slate-700">4. Patient Locations</h2>
                        <div class="flex gap-2">
                            <input type="text" id="newLocInput" placeholder="New Location..." class="border border-slate-300 rounded text-xs px-2 py-1 focus:ring-2 focus:ring-indigo-300 outline-none" onkeydown="if(event.key === 'Enter') addNewLocation()">
                            <button onclick="addNewLocation()" class="bg-indigo-600 text-white text-xs px-3 py-1.5 rounded hover:bg-indigo-700 whitespace-nowrap"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-5 gap-4" id="locationGrid"></div>
                    <p class="text-xs text-slate-400 mt-2 italic">* Paste existing patient names to assign locations.</p>
                </div>
            </div>
        </div>

        <!-- ACTION BUTTONS -->
        <div class="flex flex-col md:flex-row justify-center items-center gap-4 my-8">
            <button onclick="copyInputs()" class="bg-white text-slate-600 border border-slate-300 text-lg font-bold py-3 px-8 rounded-full shadow-sm hover:bg-slate-50 transform transition hover:scale-105 active:scale-95">
                <i class="fa-solid fa-clipboard-list mr-2"></i> Copy Inputs
            </button>
            <button onclick="calculateDistribution()" class="bg-slate-800 text-white text-xl font-bold py-3 px-12 rounded-full shadow-lg hover:bg-slate-900 transform transition hover:scale-105 active:scale-95">
                <i class="fa-solid fa-calculator mr-2"></i> Generate Schedule
            </button>
        </div>

        <!-- RESULTS SECTION -->
        <div id="resultsSection" class="hidden animate-fade-in pb-10">
            <!-- RESULTS HEADER -->
            <div class="flex flex-col md:flex-row justify-between items-end border-b pb-4 mb-6">
                <h2 class="text-2xl font-bold text-slate-800">Generation Results</h2>
                <div class="flex flex-wrap bg-slate-200 p-1 rounded-lg mt-4 md:mt-0 gap-1 items-center">
                    <button onclick="switchView('card')" id="btnViewCard" class="px-4 py-1.5 rounded-md text-sm font-semibold shadow-sm bg-white text-slate-800 transition"><i class="fa-solid fa-user-doctor mr-1"></i> Cards</button>
                    <button onclick="switchView('table')" id="btnViewTable" class="px-4 py-1.5 rounded-md text-sm font-semibold text-slate-600 hover:text-slate-800 transition"><i class="fa-solid fa-table mr-1"></i> Table</button>
                    <button onclick="switchView('timeline')" id="btnViewTimeline" class="px-4 py-1.5 rounded-md text-sm font-semibold text-slate-600 hover:text-slate-800 transition"><i class="fa-regular fa-clock mr-1"></i> Timeline</button>
                    <div class="h-6 w-px bg-slate-300 mx-1"></div>
                    <button onclick="copyCurrentOutput()" class="px-3 py-1.5 rounded-md text-sm font-bold text-indigo-600 hover:bg-indigo-50 transition border border-indigo-200"><i class="fa-solid fa-copy mr-1"></i> Copy Output</button>
                </div>
            </div>
            
            <!-- STATS CARDS -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                 <div class="bg-white p-4 rounded shadow border-l-4 border-yellow-400">
                     <div class="text-slate-500 text-sm">Avg Checks per Avail Hr</div>
                     <div class="text-2xl font-bold" id="avgLoadDisplay">-</div>
                 </div>
                 <div class="bg-white p-4 rounded shadow border-l-4 border-red-400">
                    <div class="text-slate-500 text-sm">Highest Active Checks</div>
                    <div class="text-2xl font-bold" id="maxLoadDisplay">-</div>
                </div>
                <div class="bg-white p-4 rounded shadow border-l-4 border-green-400">
                    <div class="text-slate-500 text-sm">Lowest Active Checks</div>
                    <div class="text-2xl font-bold" id="minLoadDisplay">-</div>
                </div>
            </div>

            <!-- VIEWS -->
            <div id="viewCardContainer"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="assignmentGrid"></div></div>
            
            <div id="viewTableContainer" class="hidden space-y-8">
                <!-- Summary Table -->
                <div>
                    <h3 class="text-lg font-bold text-slate-700 mb-2 ml-1">Doctor Summary</h3>
                    <div class="bg-white rounded-lg shadow overflow-x-auto border border-slate-200" id="summaryTableWrapper">
                        <!-- Content Injected via JS -->
                    </div>
                </div>
                
                <!-- Detailed Schedule Table -->
                <div>
                    <h3 class="text-lg font-bold text-slate-700 mb-2 ml-1">Patient Schedule Matrix</h3>
                    <div class="bg-white rounded-lg shadow overflow-x-auto border border-slate-200" id="detailTableWrapper">
                        <!-- Content Injected via JS -->
                    </div>
                </div>
            </div>
            
            <div id="viewTimelineContainer" class="hidden">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <div id="timelineContent" class="space-y-0 relative timeline-line"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL & TOAST -->
    <div id="importModal" class="fixed inset-0 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-2xl mx-4">
            <h2 class="text-xl font-bold mb-4 text-slate-800">Import Configuration</h2>
            <p class="text-sm text-slate-500 mb-2">Paste the text generated by the "Copy Inputs" button below.</p>
            <textarea id="importTextarea" class="w-full h-64 border p-3 rounded font-mono text-xs focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Paste data here..."></textarea>
            <div class="flex justify-end gap-3 mt-4">
                <button onclick="toggleImportModal()" class="px-4 py-2 rounded text-slate-600 hover:bg-slate-100">Cancel</button>
                <button onclick="loadConfiguration()" class="px-6 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Load Data</button>
            </div>
        </div>
    </div>

    <div id="toast">Copied to clipboard!</div>

    <!-- MAIN SCRIPT -->
    <script>
        /**
         * EQUIROUND CORE JAVASCRIPT
         * Sections:
         * 1. Global State & Constants
         * 2. Initialization & Events
         * 3. Data Management (Doctors, Locations, Patients)
         * 4. Algorithms (Distribution, Simulation)
         * 5. Rendering & UI
         * 6. Utilities
         */

        // --- 1. GLOBAL STATE & CONSTANTS ---
        let doctors = [];
        let patients = []; 
        let locations = [
            { id: 1, name: 'Aquarium' },
            { id: 2, name: 'Left Peripheral' },
            { id: 3, name: 'Left Central' },
            { id: 4, name: 'Right Central' },
            { id: 5, name: 'Right Peripheral' },
            { id: 6, name: 'Isolation Room' }
        ];
        
        // Colors for doctors in table view
        const DOC_COLORS = [
            { bg: 'bg-blue-100', text: 'text-blue-800' },
            { bg: 'bg-green-100', text: 'text-green-800' },
            { bg: 'bg-purple-100', text: 'text-purple-800' },
            { bg: 'bg-orange-100', text: 'text-orange-800' },
            { bg: 'bg-pink-100', text: 'text-pink-800' },
            { bg: 'bg-teal-100', text: 'text-teal-800' },
            { bg: 'bg-indigo-100', text: 'text-indigo-800' },
            { bg: 'bg-red-100', text: 'text-red-800' },
            { bg: 'bg-yellow-100', text: 'text-yellow-800' },
            { bg: 'bg-cyan-100', text: 'text-cyan-800' }
        ];

        // Configuration State
        let shiftHours = 12;
        let q2Offset = 0;
        let q4Offset = 0;
        let q8Offset = 0; 
        let patientEntryCounter = 0; // Ensures stable sort order for patients
        
        // Result State
        let currentAssignment = null;
        let currentSchedule = null;
        let currentView = 'card';
        
        // UI State
        let expandedDocIds = new Set(); // Tracks open accordions

        // --- 2. INITIALIZATION & EVENTS ---
        
        function init() {
            // Bind config inputs
            document.getElementById('startTime').addEventListener('change', updateDuration);
            document.getElementById('endTime').addEventListener('change', updateDuration);
            document.getElementById('q2Offset').addEventListener('change', updateDuration);
            document.getElementById('q4Offset').addEventListener('change', updateDuration);
            document.getElementById('q8Offset').addEventListener('change', updateDuration);
            
            // Initial render
            updateDuration();
            renderLocations();
        }

        // Call init immediately
        init();

        // UI Updates for Sliders
        function updateEquityDisplay() {
            const val = document.getElementById('equitySlider').value;
            const text = val == 100 ? "Respect Availability: 100%" : 
                         val == 0 ? "Ignore Availability (Equal Totals)" : 
                         `Respect Availability: ${val}%`;
            document.getElementById('equityValueDisplay').innerText = text;
        }

        function updateClusterDisplay() {
            const val = parseInt(document.getElementById('clusterSlider').value);
            const display = document.getElementById('clusterValueDisplay');
            const slider = document.getElementById('clusterSlider');
            
            let text = `Location Bonus: ${val}%`;
            if (val > 30) {
                text += " (Danger Zone!)";
                display.className = "text-center text-xs font-bold text-red-600 mt-1";
                slider.classList.remove('accent-indigo-600');
                slider.classList.add('accent-red-600');
            } else {
                display.className = "text-center text-xs font-semibold text-indigo-600 mt-1";
                slider.classList.remove('accent-red-600');
                slider.classList.add('accent-indigo-600');
            }
            display.innerText = text;
        }

        // --- 3. DATA MANAGEMENT ---

        function addDoctor() {
            const nameInput = document.getElementById('newDocName');
            const name = nameInput.value.trim();
            if (!name) return;
            if (doctors.find(d => d.name === name)) { alert('Doctor already exists!'); return; }
            doctors.push({ id: Date.now(), name: name, ranges: [] });
            nameInput.value = '';
            renderAll();
        }

        function removeDoctor(name) {
            doctors = doctors.filter(d => d.name !== name);
            patients.forEach(p => { if (p.pref === name) p.pref = ""; });
            renderAll();
        }

        function addRange(docId) {
            const sVal = document.getElementById(`start-${docId}`).value;
            const eVal = document.getElementById(`end-${docId}`).value;
            if(!sVal || !eVal) return;
            const doc = doctors.find(d => d.id === docId);
            if(doc) {
                doc.ranges.push({start: sVal, end: eVal});
                renderDoctors();
            }
        }

        function removeRange(docId, index) {
            const doc = doctors.find(d => d.id === docId);
            if(doc) {
                doc.ranges.splice(index, 1);
                renderDoctors();
            }
        }

        // Locations
        function addNewLocation() {
            const input = document.getElementById('newLocInput');
            const newName = input.value;
            if (newName && newName.trim()) {
                locations.push({ id: Date.now(), name: newName.trim() });
                renderLocations();
                input.value = '';
                input.focus();
            }
        }

        function removeLocation(id) {
            locations = locations.filter(l => l.id !== id);
            renderLocations();
        }

        function updateLocationName(id, newName) {
            const loc = locations.find(l => l.id === id);
            if (loc) { loc.name = newName; }
        }

        // Patients
        function handlePatientInput(event, freq) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                const input = event.target;
                const rawValue = input.value;
                const names = rawValue.split(/[\n,]+/).map(n => n.trim()).filter(n => n);
                if (names.length > 0) {
                    names.forEach(name => {
                         patients.push({ 
                             id: Date.now() + Math.random(), 
                             name: name, 
                             freq: parseInt(freq), 
                             pref: "", 
                             location: "",
                             staggerOffset: 0,
                             entryOrder: patientEntryCounter++ 
                        });
                    });
                    renderAll();
                    input.value = '';
                }
            }
        }

        function removePatient(id) {
            patients = patients.filter(p => p.id !== id);
            renderAll();
        }

        function updatePatientPref(id, newPref) {
            const p = patients.find(pat => pat.id === id);
            if (p) { p.pref = newPref; renderAll(); }
        }

        function removeLocationFromPatient(patientId) {
            const p = patients.find(pat => pat.id === patientId);
            if (p) { p.location = ""; renderAll(); }
        }

        function handleLocationInput(event, locName) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                const input = event.target;
                const rawValue = input.value;
                const namesToMatch = rawValue.split(/[\n,]+/).map(n => n.trim().toLowerCase()).filter(n => n);
                
                if (namesToMatch.length > 0) {
                    let matchCount = 0;
                    patients.forEach(p => {
                        if (namesToMatch.includes(p.name.toLowerCase())) {
                            p.location = locName;
                            matchCount++;
                        }
                    });
                    if(matchCount === 0) {
                        alert("No matching patients found. Ensure exact name match.");
                    } else {
                        renderAll(); 
                        input.value = '';
                    }
                }
            }
        }

        function handleDocPrefInput(event, docName, docId) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                const input = event.target;
                const rawValue = input.value;
                const namesToMatch = rawValue.split(/[\n,]+/).map(n => n.trim().toLowerCase()).filter(n => n);
                
                if (namesToMatch.length > 0) {
                    let matchCount = 0;
                    patients.forEach(p => {
                        if (namesToMatch.includes(p.name.toLowerCase())) {
                            p.pref = docName;
                            matchCount++;
                        }
                    });
                    if(matchCount === 0) alert("No matching patients found.");
                    else { 
                        renderAll(); 
                        // Restore Focus
                        setTimeout(() => {
                            const newInput = document.getElementById(`pref-input-${docId}`);
                            if(newInput) {
                                newInput.focus();
                                newInput.value = '';
                            }
                        }, 0);
                    }
                }
            }
        }

        function removePrefFromDoc(patientId) {
            const p = patients.find(pat => pat.id === patientId);
            if(p) { p.pref = ""; renderAll(); }
        }

        // --- 4. ALGORITHMS ---

        /**
         * Core Distribution Logic
         * Balances Primary Patient Assignment based on "Phantom Load" theory.
         */
        function calculateDistribution() {
            if (doctors.length === 0) { alert("Please add doctors."); return; }
            if (patients.length === 0) { alert("Please add patients."); return; }
            
            // 1. Get Settings
            const equityFactor = parseInt(document.getElementById('equitySlider').value) / 100;
            const clusterVal = parseInt(document.getElementById('clusterSlider').value);
            const useTimeBlocking = document.getElementById('timeBlockingToggle').checked;
            const useStagger = document.getElementById('staggerToggle').checked;
            
            // Map 0-100 to discount (e.g. 15 -> 0.15 discount -> 0.85 multiplier)
            const clusterDiscount = clusterVal / 100;
            const clusterMultiplier = 1.0 - clusterDiscount;

            // Clear previous stagger
            patients.forEach(p => p.staggerOffset = 0);

            // 2. Init Calculations
            let totalBurden = 0;
            patients.forEach(p => totalBurden += getBurden(p));

            // 3. Concurrency / Uniqueness Scoring
            // Determine how "scarce" a doctor is. High score = working solo/late.
            const totalHoursInt = Math.ceil(shiftHours);
            let hourlyCounts = new Array(totalHoursInt).fill(0);
            
            doctors.forEach(d => {
                d.availHours = getDoctorAvailableHours(d); 
                for(let h=0; h<totalHoursInt; h++) {
                    if(isDoctorAvailableAtHour(d, h)) hourlyCounts[h]++;
                }
            });

            // Calculate Coverage Score (Squared Weighting for Scarcity)
            let totalCoverageScore = 0;
            doctors.forEach(d => {
                d.coverageScore = 0;
                for(let h=0; h<totalHoursInt; h++) {
                    if(isDoctorAvailableAtHour(d, h)) {
                        let count = hourlyCounts[h];
                        if(count > 0) d.coverageScore += Math.pow(1.0 / count, 2);
                    }
                }
                totalCoverageScore += d.coverageScore;
            });

            // 4. Initialize Assignment Objects with Phantom Load
            let assignment = {};
            doctors.forEach(d => { 
                // Coefficient Tuning:
                let coverageRatio = totalCoverageScore > 0 ? d.coverageScore / totalCoverageScore : 0;
                const incomingLoad = totalBurden * 0.85 * coverageRatio;

                const debtRatio = shiftHours > 0 ? (1.0 - (d.availHours / shiftHours)) : 0;
                const debtLoad = totalBurden * 0.15 * debtRatio;

                // Phantom Load only applies when aiming for Equal Totals (equityFactor < 1)
                const phantomLoad = (incomingLoad + debtLoad) * (1 - equityFactor);

                assignment[d.name] = { 
                    ...d, 
                    patients: [], 
                    activeLoad: 0, 
                    burdenLoad: 0,
                    simulatedLoad: phantomLoad 
                }; 
            });

            // --- TIME BLOCKING MODE ---
            let blockSchedule = null; // Map of hour -> docName

            if (useTimeBlocking) {
                blockSchedule = new Array(totalHoursInt).fill(null);
                
                // 1. Calculate Burden Per Hour
                let hourlyBurden = new Array(totalHoursInt).fill(0);
                patients.forEach(p => {
                    for (let h = 0; h < totalHoursInt; h++) {
                        if (isCheckDue(p.freq, h, p)) hourlyBurden[h]++;
                    }
                });

                // 2. Sort hours by burden (desc) to assign hardest hours first
                let hoursSorted = [];
                for(let h=0; h<totalHoursInt; h++) hoursSorted.push(h);
                hoursSorted.sort((a,b) => hourlyBurden[b] - hourlyBurden[a]);

                // 3. Assign Blocks
                hoursSorted.forEach(h => {
                    // Find available doctors for this hour
                    let availableDocs = Object.values(assignment).filter(d => isDoctorAvailableAtHour(d, h));
                    
                    if (availableDocs.length > 0) {
                        // Pick doc with lowest (CurrentLoad / Capacity)
                        availableDocs.sort((a, b) => {
                            const capA = (a.availHours * equityFactor) + (1 * (1 - equityFactor));
                            const capB = (b.availHours * equityFactor) + (1 * (1 - equityFactor));
                            const safeCapA = Math.max(capA, 0.1);
                            const safeCapB = Math.max(capB, 0.1);

                            // Load includes phantom + already assigned blocks
                            const scoreA = (a.simulatedLoad + hourlyBurden[h]) / safeCapA;
                            const scoreB = (b.simulatedLoad + hourlyBurden[h]) / safeCapB;
                            return scoreA - scoreB;
                        });

                        let chosen = availableDocs[0];
                        blockSchedule[h] = chosen.name;
                        chosen.simulatedLoad += hourlyBurden[h]; // Update load for next decision
                    }
                });
                
                // Apply Staggering (Global Round Robin)
                if (useStagger) {
                    const byFreq = { 2: [], 4: [], 8: [] };
                    patients.forEach(p => { if(byFreq[p.freq]) byFreq[p.freq].push(p); });
                    
                    [2, 4, 8].forEach(f => {
                         // Sort by entry order to keep consistent
                         byFreq[f].sort((a,b) => (a.entryOrder||0) - (b.entryOrder||0));
                         byFreq[f].forEach((p, i) => p.staggerOffset = i % f);
                    });
                }
            } 
            else {
                // --- NORMAL MODE (Greedy Patient Assignment) ---
                let unassigned = [...patients];

                // Sort by burden (descending) to place heavy patients first
                unassigned.sort(() => Math.random() - 0.5);
                unassigned.sort((a, b) => getBurden(b) - getBurden(a));

                unassigned.forEach(p => {
                    let docObjects = Object.values(assignment);
                    
                    docObjects.sort((a, b) => {
                        const costA = getCheckCountForDoc(p, a);
                        const costB = getCheckCountForDoc(p, b);

                        // Effective Capacity Scaling
                        const capA = (a.availHours * equityFactor) + (1 * (1 - equityFactor));
                        const capB = (b.availHours * equityFactor) + (1 * (1 - equityFactor));
                        const safeCapA = Math.max(capA, 0.1);
                        const safeCapB = Math.max(capB, 0.1);

                        // Score: (Handicap + Allocated + NewCost) / Capacity
                        let scoreA = (a.simulatedLoad + costA) / safeCapA;
                        let scoreB = (b.simulatedLoad + costB) / safeCapB;

                        // Preference Bonus
                        const prefBonus = 0.6 + (0.39 * (1 - equityFactor));
                        
                        if (p.pref === a.name) scoreA *= prefBonus;
                        if (p.pref === b.name) scoreB *= prefBonus;

                        // Clustering Bonus
                        const hasLocA = a.patients.some(existing => existing.location === p.location);
                        const hasLocB = b.patients.some(existing => existing.location === p.location);
                        
                        if (hasLocA) scoreA *= clusterMultiplier; 
                        if (hasLocB) scoreB *= clusterMultiplier;

                        return scoreA - scoreB;
                    });
                    
                    let target = docObjects[0];
                    target.patients.push(p);
                    target.burdenLoad += getBurden(p);
                    target.simulatedLoad += getCheckCountForDoc(p, target);
                });

                // Apply Staggering (Per-Doctor Round Robin)
                if (useStagger) {
                    Object.values(assignment).forEach(doc => {
                         const byFreq = { 2: [], 4: [], 8: [] };
                         doc.patients.forEach(p => { if(byFreq[p.freq]) byFreq[p.freq].push(p); });
                         [2, 4, 8].forEach(f => {
                             byFreq[f].sort((a,b) => (a.entryOrder||0) - (b.entryOrder||0)); // stable sort
                             byFreq[f].forEach((p, i) => p.staggerOffset = i % f);
                         });
                    });
                }
            }

            // 6. Run Simulation to determine Coverage/Block Assignments
            // Pass blockSchedule (is null in normal mode)
            const simulation = simulateSchedule(assignment, blockSchedule);
            
            // 7. Update Real Active Stats
            Object.keys(assignment).forEach(k => {
                assignment[k].activeLoad = simulation.stats[k].active;
            });

            // 7b. If Block Mode, Populate "Primary" Patients for Visuals
            if (useTimeBlocking) {
                // Assign patient to the doctor who checked them the most
                patients.forEach(p => {
                    let maxChecks = -1;
                    let bestDoc = null;
                    
                    // Count checks per doc for this patient
                    Object.keys(simulation.stats).forEach(docName => {
                        let checks = 0;
                        // Scan schedule
                        simulation.schedule.forEach(hourMap => {
                            if (hourMap[docName]) {
                                if (hourMap[docName].some(t => t.patient.id === p.id)) checks++;
                            }
                        });
                        
                        if (checks > maxChecks) {
                            maxChecks = checks;
                            bestDoc = docName;
                        }
                    });

                    if (bestDoc && assignment[bestDoc]) {
                        assignment[bestDoc].patients.push(p);
                        assignment[bestDoc].burdenLoad += getBurden(p); // Rough attribution
                    }
                });
            }
            
            // 8. Commit & Render
            currentAssignment = assignment;
            currentSchedule = simulation.schedule; 

            renderResults(assignment);
            renderSummaryTable(assignment);
            renderTimeline(assignment); 
            
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        /**
         * Simulation Logic
         * Runs hour-by-hour to determine who covers whom.
         * Uses "Decision Load" (Projected Total) to intelligently assign coverage.
         */
        function simulateSchedule(assignment, blockSchedule = null) {
            const docKeys = Object.keys(assignment);
            const totalHoursInt = Math.ceil(shiftHours);
            const equityFactor = parseInt(document.getElementById('equitySlider').value) / 100;
            
            let simStats = {};
            let decisionLoad = {}; // Tracks Projected Total Load

            docKeys.forEach(k => {
                simStats[k] = { active: 0, hourlyLoad: new Array(totalHoursInt).fill(0) };
                decisionLoad[k] = assignment[k].simulatedLoad || 0;
            });

            // Create flat task list
            let allTasks = [];
            Object.values(assignment).forEach(primaryDoc => {
                // In Block Mode, patients list is empty initially, so we iterate GLOBAL patients
                let sourcePatients = blockSchedule ? patients : primaryDoc.patients;
                
                sourcePatients.forEach(p => {
                    for (let h = 0; h < totalHoursInt; h++) {
                        if (isCheckDue(p.freq, h, p)) {
                            allTasks.push({ patient: p, primaryDoc: primaryDoc, hour: h });
                        }
                    }
                });
            });
            
            // Remove duplicates in Block Mode (since we iterated global list for each doc)
            if (blockSchedule) {
                // In Block mode above loop runs N times (N=docs). 
                // We actually just want to generate tasks once.
                allTasks = [];
                patients.forEach(p => {
                    for (let h = 0; h < totalHoursInt; h++) {
                        if (isCheckDue(p.freq, h, p)) {
                            // Primary doc doesn't matter in block mode
                            allTasks.push({ patient: p, primaryDoc: null, hour: h });
                        }
                    }
                });
            }

            allTasks.sort((a,b) => a.hour - b.hour);

            let hourlyPlan = []; 

            // Process Hour-by-Hour
            for (let h = 0; h < totalHoursInt; h++) {
                let hourTasks = allTasks.filter(t => t.hour === h);
                let hourAssignments = {};
                
                if (blockSchedule) {
                    // --- BLOCK MODE ASSIGNMENT ---
                    let blockDocName = blockSchedule[h];
                    
                    if (blockDocName && assignment[blockDocName]) {
                        hourAssignments[blockDocName] = [];
                        hourTasks.forEach(t => {
                            simStats[blockDocName].active++;
                            simStats[blockDocName].hourlyLoad[h]++;
                            // Add task to doc
                            hourAssignments[blockDocName].push({ ...t, isCoverage: false, primaryDoc: assignment[blockDocName] });
                        });
                    } else {
                        // Unassigned (No available doc for this block)
                        let key = "UNASSIGNED";
                        hourAssignments[key] = [];
                        hourTasks.forEach(t => hourAssignments[key].push({ ...t, isCoverage: false, unassigned: true }));
                    }
                } else {
                    // --- NORMAL MODE ASSIGNMENT ---
                    let pending = [];
                    
                    hourTasks.forEach(t => {
                        // Try Primary
                        if (t.primaryDoc && isDoctorAvailableAtHour(t.primaryDoc, h)) {
                            simStats[t.primaryDoc.name].active++;
                            simStats[t.primaryDoc.name].hourlyLoad[h]++;
                            
                            if(!hourAssignments[t.primaryDoc.name]) hourAssignments[t.primaryDoc.name] = [];
                            hourAssignments[t.primaryDoc.name].push({ ...t, isCoverage: false });
                        } else {
                            pending.push(t);
                        }
                    });

                    // Assign Coverage
                    pending.forEach(t => {
                        let availableDocs = docKeys.filter(name => isDoctorAvailableAtHour(assignment[name], h));
                        
                        if (availableDocs.length === 0) {
                            let key = "UNASSIGNED";
                            if(!hourAssignments[key]) hourAssignments[key] = [];
                            hourAssignments[key].push({ ...t, isCoverage: false, unassigned: true });
                        } else {
                            // Intelligent Sorting
                            availableDocs.sort((a,b) => {
                                const capA = (assignment[a].availHours * equityFactor) + (1 * (1 - equityFactor));
                                const capB = (assignment[b].availHours * equityFactor) + (1 * (1 - equityFactor));
                                const safeCapA = Math.max(capA, 0.1);
                                const safeCapB = Math.max(capB, 0.1);

                                const metricA = decisionLoad[a] / safeCapA;
                                const metricB = decisionLoad[b] / safeCapB;
                                
                                if (Math.abs(metricA - metricB) < 0.05) {
                                    return simStats[a].active - simStats[b].active;
                                }
                                return metricA - metricB;
                            });

                            let coverDocName = availableDocs[0];
                            simStats[coverDocName].active++;
                            simStats[coverDocName].hourlyLoad[h]++;
                            decisionLoad[coverDocName]++; // Increment projected load
                            
                            if(!hourAssignments[coverDocName]) hourAssignments[coverDocName] = [];
                            hourAssignments[coverDocName].push({ ...t, isCoverage: true });
                        }
                    });
                }
                
                hourlyPlan.push(hourAssignments);
            }

            return { stats: simStats, schedule: hourlyPlan };
        }

        // --- 5. RENDERING & UI ---

        function renderAll() {
            renderDoctors();
            renderPatientLists();
            renderLocations();
        }

        function renderDoctors() {
            const docListEl = document.getElementById('docList');
            docListEl.innerHTML = '';
            doctors.forEach((d, index) => {
                const prefs = patients.filter(p => p.pref === d.name);
                const card = document.createElement('div');
                card.className = "bg-white border rounded shadow-sm text-sm overflow-hidden transition-all";
                const header = document.createElement('div');
                header.className = "p-3 flex justify-between items-center bg-slate-50 cursor-pointer hover:bg-slate-100";
                
                let rangeText = "";
                if(d.ranges.length > 0) {
                    rangeText = `<span class="text-xs text-green-600 bg-green-50 border border-green-200 rounded px-1 ml-1">${d.ranges.length} Ranges</span>`;
                }

                header.onclick = (e) => {
                    if(e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON' && !e.target.closest('button')) 
                        toggleDocAccordion(index);
                };

                // State Check
                const isExpanded = expandedDocIds.has(d.id);
                const bodyClass = isExpanded ? "max-h-96 border-t border-slate-100 bg-white" : "max-h-0 border-t border-slate-100 bg-white";
                const arrowTransform = isExpanded ? 'rotate(180deg)' : 'rotate(0deg)';

                header.innerHTML = `
                    <div class="flex items-center gap-2 font-medium text-slate-700">
                        <i class="fa-solid fa-user-doctor text-slate-400"></i>
                        ${d.name}
                        ${prefs.length > 0 ? `<span class="bg-amber-100 text-amber-700 text-xs px-2 py-0.5 rounded-full">${prefs.length}</span>` : ''}
                        ${rangeText}
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="toggleDocAccordion(${index}); event.stopPropagation();" class="text-slate-400 hover:text-blue-500" title="Set Availability"><i class="fa-regular fa-clock"></i></button>
                        <i id="arrow-${index}" class="fa-solid fa-chevron-down text-xs text-slate-400 transition-transform" style="transform: ${arrowTransform}"></i>
                    </div>
                `;

                const body = document.createElement('div');
                body.id = `doc-body-${index}`;
                body.className = bodyClass; 
                
                let prefsHtml = prefs.map(p => `
                    <span class="inline-flex items-center gap-1 bg-amber-50 text-amber-800 text-xs px-2 py-1 rounded border border-amber-100 mb-1">
                        ${p.name} <span class="text-[10px] text-amber-400">(Q${p.freq})</span>
                        <button onclick="removePrefFromDoc(${p.id})" class="hover:text-red-600 ml-1"><i class="fa-solid fa-times"></i></button>
                    </span>
                `).join('');

                let rangesHtml = d.ranges.map((r, i) => `
                    <div class="flex justify-between text-xs bg-slate-50 p-1 rounded border mb-1">
                        <span>${r.start} - ${r.end}</span>
                        <button onclick="removeRange(${d.id}, ${i})" class="text-red-400 hover:text-red-600 px-1">&times;</button>
                    </div>
                `).join('');

                body.innerHTML = `
                    <div class="p-3 space-y-4">
                        <div class="bg-blue-50 p-2 rounded border border-blue-100">
                            <div class="text-[10px] uppercase font-bold text-blue-500 mb-1">Availability (Default: Full Shift)</div>
                            <div class="mb-2">${rangesHtml}</div>
                            <div class="flex gap-1">
                                <input type="time" id="start-${d.id}" class="w-1/2 p-1 text-xs border rounded">
                                <input type="time" id="end-${d.id}" class="w-1/2 p-1 text-xs border rounded">
                                <button onclick="addRange(${d.id})" class="bg-blue-500 text-white px-2 rounded text-xs"><i class="fa-solid fa-plus"></i></button>
                            </div>
                        </div>
                        <div>
                            <div class="text-[10px] uppercase font-bold text-slate-400 mb-1">Preferred Patients</div>
                            <div class="flex flex-wrap gap-1">
                                ${prefsHtml || '<span class="text-xs text-slate-400 italic">None</span>'}
                            </div>
                            <textarea id="pref-input-${d.id}" placeholder="Bulk add pref names..." rows="2" class="w-full text-xs p-2 border rounded focus:ring-1 focus:ring-green-400 mt-1 resize-none" onkeydown="handleDocPrefInput(event, '${d.name}', ${d.id})"></textarea>
                        </div>
                        <div class="text-right pt-1"><button onclick="removeDoctor('${d.name}')" class="text-xs text-red-400 hover:text-red-600 underline">Remove Doctor</button></div>
                    </div>
                `;
                card.appendChild(header);
                card.appendChild(body);
                docListEl.appendChild(card);
            });
        }

        function toggleDocAccordion(index) {
            const body = document.getElementById(`doc-body-${index}`);
            const arrow = document.getElementById(`arrow-${index}`);
            const doc = doctors[index];

            if (body.classList.contains('max-h-0')) {
                body.classList.remove('max-h-0');
                body.classList.add('max-h-96');
                arrow.style.transform = 'rotate(180deg)';
                if(doc) expandedDocIds.add(doc.id);
            } else {
                body.classList.add('max-h-0');
                body.classList.remove('max-h-96');
                arrow.style.transform = 'rotate(0deg)';
                if(doc) expandedDocIds.delete(doc.id);
            }
        }

        function renderPatientLists() {
            document.getElementById('patientCountBadge').innerText = `${patients.length} Patients`;
            [1, 2, 4, 8].forEach(q => {
                const listEl = document.getElementById(`list-q${q}`);
                const countEl = document.getElementById(`count-q${q}`);
                const qPatients = patients.filter(p => p.freq === q);
                countEl.innerText = qPatients.length;
                listEl.innerHTML = '';
                qPatients.forEach(p => {
                    let optionsHTML = `<option value="">No Pref</option>`;
                    doctors.forEach(d => {
                        const selected = p.pref === d.name ? 'selected' : '';
                        optionsHTML += `<option value="${d.name}" ${selected}>${d.name}</option>`;
                    });
                    
                    const borderClass = p.pref ? 'border-amber-300 bg-amber-50' : 'border-slate-200 bg-white';
                    const locBadge = p.location 
                        ? `<span class="text-[10px] bg-indigo-100 text-indigo-700 px-1 rounded ml-1 truncate max-w-[80px]">${p.location}</span>` 
                        : '';

                    const item = document.createElement('div');
                    item.className = `${borderClass} p-2 rounded shadow-sm border flex flex-col gap-2 animate-fade-in`;
                    item.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex flex-col truncate w-full">
                                <span class="font-medium text-slate-800 text-sm truncate" title="${p.name}">${p.name}</span>
                                ${locBadge ? `<div class="mt-0.5">${locBadge}</div>` : ''}
                            </div>
                            <button onclick="removePatient(${p.id})" class="text-slate-300 hover:text-red-500 ml-2"><i class="fa-solid fa-times"></i></button>
                        </div>
                        <select onchange="updatePatientPref(${p.id}, this.value)" class="w-full text-xs p-1 border rounded bg-white text-slate-600 focus:outline-none focus:ring-1 focus:ring-blue-300">
                            ${optionsHTML}
                        </select>
                    `;
                    listEl.appendChild(item);
                });
            });
        }

        function renderLocations() {
            const locGridEl = document.getElementById('locationGrid');
            locGridEl.innerHTML = '';
            locations.forEach(loc => {
                const locPatients = patients.filter(p => p.location === loc.name);
                const count = locPatients.length;

                let tagsHtml = locPatients.map(p => `
                    <span class="inline-flex items-center gap-1 bg-indigo-100 text-indigo-800 text-[10px] px-2 py-1 rounded border border-indigo-200">
                        ${p.name}
                        <button onclick="removeLocationFromPatient(${p.id})" class="hover:text-red-600 ml-1 font-bold text-indigo-400 hover:bg-indigo-50 rounded-full w-3 h-3 flex items-center justify-center">&times;</button>
                    </span>
                `).join('');

                const card = document.createElement('div');
                card.className = "bg-indigo-50 border border-indigo-100 rounded p-3 flex flex-col gap-2 relative group";
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-1 pr-6">
                        <input type="text" value="${loc.name}" 
                            class="bg-transparent font-bold text-indigo-900 text-sm w-full focus:outline-none focus:border-b border-indigo-300"
                            onchange="updateLocationName(${loc.id}, this.value)">
                        <span class="bg-indigo-200 text-indigo-800 text-[10px] px-1.5 py-0.5 rounded-full font-mono whitespace-nowrap">${count}</span>
                    </div>
                    <div class="flex flex-wrap gap-1 mb-1 max-h-24 overflow-y-auto patient-list-scroll">
                        ${tagsHtml || '<span class="text-[10px] text-indigo-300 italic">No patients assigned</span>'}
                    </div>
                    <textarea rows="2" placeholder="Paste names to add..." 
                        class="w-full text-xs p-1.5 border border-indigo-200 rounded focus:ring-1 focus:ring-indigo-400 resize-none bg-white mt-auto"
                        onkeydown="handleLocationInput(event, '${loc.name}')"></textarea>
                    
                    <button onclick="removeLocation(${loc.id})" class="absolute top-1 right-1 text-indigo-300 hover:text-red-500 transition z-10 p-1">
                        <i class="fa-solid fa-times-circle"></i>
                    </button>
                `;
                locGridEl.appendChild(card);
            });
        }

        function renderResults(assignment) {
            const container = document.getElementById('assignmentGrid');
            container.innerHTML = '';

            const docs = Object.values(assignment);
            const activeLoads = docs.map(d => d.activeLoad);
            const totalActive = activeLoads.reduce((a,b)=>a+b, 0);
            const totalHours = docs.reduce((a,b)=>a+b.availHours, 0);
            const avgPerHr = totalHours > 0 ? (totalActive / totalHours).toFixed(2) : 0;

            document.getElementById('avgLoadDisplay').innerText = avgPerHr;
            document.getElementById('maxLoadDisplay').innerText = Math.max(...activeLoads);
            document.getElementById('minLoadDisplay').innerText = Math.min(...activeLoads);

            docs.forEach(d => {
                // Sorting for Output: Location Index > Entry Order
                d.patients.sort(patientComparator);

                let pListHTML = d.patients.map(p => `
                    <div class="flex justify-between items-center text-sm p-2 bg-slate-50 rounded mb-1 border-l-4 ${getQColor(p.freq)}">
                        <div class="flex flex-col">
                            <span>${p.name}</span>
                            ${p.location ? `<span class="text-[10px] text-indigo-500 italic">${p.location}</span>` : ''}
                        </div>
                        <div class="flex items-center gap-1">
                            ${p.pref ? '<i class="fa-solid fa-star text-xs text-amber-500"></i>' : ''}
                            <span class="font-mono font-bold text-slate-500 text-xs">Q${p.freq}</span>
                        </div>
                    </div>
                `).join('');

                const card = document.createElement('div');
                card.className = `card p-5 border-t-8 border-blue-500 fade-in`;
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-slate-800">${d.name}</h3>
                            <div class="text-xs text-slate-400">Available: ${d.availHours.toFixed(1)}h</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xl font-bold text-slate-700">Act: ${d.activeLoad}</div>
                            <div class="text-[10px] text-slate-400 uppercase">Burden: ${d.burdenLoad}</div>
                        </div>
                    </div>
                    <div class="space-y-1">
                        ${pListHTML}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- HELPER FOR DOCTOR COLOR ---
        function getDoctorColorClass(docName) {
            const idx = doctors.findIndex(d => d.name === docName);
            if (idx === -1) return { bg: 'bg-slate-100', text: 'text-slate-600' };
            return DOC_COLORS[idx % DOC_COLORS.length];
        }

        function renderSummaryTable(assignment) {
            const summaryContainer = document.getElementById('summaryTableWrapper');
            const detailContainer = document.getElementById('detailTableWrapper');
            
            // --- 1. RENDER DOCTOR SUMMARY TABLE ---
            let headerHTML = `<table class="w-full text-sm text-left text-slate-600"><thead class="text-xs text-slate-700 uppercase bg-slate-50 border-b">
                <tr><th class="px-6 py-3 font-bold text-slate-800 whitespace-nowrap bg-slate-50 sticky left-0 z-10 border-r">Doctor</th>`;
            locations.forEach(l => {
                headerHTML += `<th class="px-4 py-3 text-xs font-bold text-indigo-700 bg-indigo-50/50 text-center whitespace-nowrap border-r border-indigo-100">${l.name}</th>`;
            });
            headerHTML += `<th class="px-4 py-3 text-red-600 bg-red-50 text-center border-r border-red-100">Q1</th>
                    <th class="px-4 py-3 text-orange-600 bg-orange-50 text-center border-r border-orange-100">Q2</th>
                    <th class="px-4 py-3 text-blue-600 bg-blue-50 text-center border-r border-blue-100">Q4</th>
                    <th class="px-4 py-3 text-green-600 bg-green-50 text-center border-r border-green-100">Q8</th>
                    <th class="px-6 py-3 font-bold text-slate-800 bg-slate-100 text-right whitespace-nowrap">Active / Burden</th>
                    <th class="px-6 py-3 font-bold text-slate-800 bg-slate-100 text-right whitespace-nowrap">Avail Hrs</th></tr></thead><tbody class="divide-y divide-slate-100">`;

            Object.values(assignment).forEach(doc => {
                const q1 = doc.patients.filter(p => p.freq === 1).length;
                const q2 = doc.patients.filter(p => p.freq === 2).length;
                const q4 = doc.patients.filter(p => p.freq === 4).length;
                const q8 = doc.patients.filter(p => p.freq === 8).length;
                
                let locCells = '';
                locations.forEach(l => {
                    const count = doc.patients.filter(p => p.location === l.name).length;
                    const style = count > 0 ? "font-bold text-indigo-700 bg-indigo-50/30" : "text-slate-300 bg-white";
                    locCells += `<td class="px-4 py-4 text-center border-r border-slate-100 text-xs ${style}">${count > 0 ? count : '-'}</td>`;
                });

                // Get doctor color badge
                const color = getDoctorColorClass(doc.name);
                
                headerHTML += `
                    <tr class="hover:bg-slate-50 border-b last:border-0">
                        <td class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap bg-white sticky left-0 border-r font-bold">
                            <span class="${color.bg} ${color.text} px-2 py-1 rounded text-xs mr-2 border border-black/10">${doc.name}</span>
                        </td>
                        ${locCells}
                        <td class="px-4 py-4 bg-red-50/10 font-mono text-red-700 font-bold text-center border-r border-slate-100">${q1}</td>
                        <td class="px-4 py-4 bg-orange-50/10 font-mono text-orange-700 font-bold text-center border-r border-slate-100">${q2}</td>
                        <td class="px-4 py-4 bg-blue-50/10 font-mono text-blue-700 font-bold text-center border-r border-slate-100">${q4}</td>
                        <td class="px-4 py-4 bg-green-50/10 font-mono text-green-700 font-bold text-center border-r border-slate-100">${q8}</td>
                        <td class="px-6 py-4 text-right font-bold text-lg bg-slate-50 whitespace-nowrap">${doc.activeLoad} <span class="text-xs font-normal text-slate-400">/ ${doc.burdenLoad}</span></td>
                        <td class="px-6 py-4 text-right text-slate-500 whitespace-nowrap">${doc.availHours.toFixed(1)}h</td>
                    </tr>
                `;
            });
            headerHTML += `</tbody></table>`;
            summaryContainer.innerHTML = headerHTML;

            // --- 2. RENDER DETAILED SCHEDULE TABLE ---
            
            // Build Time Headers
            const startStr = document.getElementById('startTime').value;
            const totalHoursInt = Math.ceil(shiftHours);
            let timeHeaders = '';
            for(let i=0; i<totalHoursInt; i++) {
                let d = new Date(`01/01/2000 ${startStr}`);
                d.setHours(d.getHours() + i);
                let timeText = d.toLocaleTimeString([], {hour: 'numeric', hour12: true}).replace(" ", "").toLowerCase();
                timeHeaders += `<th class="px-2 py-3 text-xs text-slate-500 text-center border-l border-slate-200 bg-slate-50 min-w-[50px]">${timeText}</th>`;
            }

            // Table Header
            let detailHTML = `<table class="w-full text-sm text-left border-collapse"><thead class="text-xs text-slate-700 uppercase bg-slate-100 border-b">
                <tr>
                    <th class="px-4 py-3 sticky left-0 bg-slate-100 z-30 border-r w-48 shadow-sm">Patient</th>
                    <th class="px-2 py-3 text-center border-r bg-slate-50">Freq</th>
                    ${timeHeaders}
                </tr></thead><tbody class="divide-y divide-slate-200">`;

            // Sort all patients by Location > Entry
            let sortedPatients = [...patients].sort(patientComparator);
            let lastLoc = "___START___";

            sortedPatients.forEach(p => {
                let currentLoc = p.location || "Unspecified";
                
                // Insert Location Header Row if location changes
                if (currentLoc !== lastLoc) {
                    detailHTML += `
                        <tr class="bg-indigo-50 border-y border-indigo-100">
                            <td class="px-4 py-1.5 text-xs font-bold text-indigo-800 uppercase tracking-wider sticky left-0 z-20 bg-indigo-50 border-r border-indigo-100 shadow-sm">
                                <div class="truncate w-44"><i class="fa-solid fa-location-dot mr-1 opacity-50"></i> ${currentLoc}</div>
                            </td>
                            <td colspan="${1 + totalHoursInt}" class="bg-indigo-50"></td>
                        </tr>
                    `;
                    lastLoc = currentLoc;
                }
                
                const qColorText = getQTextColor(p.freq);
                const qBadge = `<span class="font-mono font-bold ${qColorText}">Q${p.freq}</span>`;
                
                detailHTML += `
                    <tr class="hover:bg-slate-50 bg-white group">
                        <td class="px-4 py-2 sticky left-0 bg-white group-hover:bg-slate-50 z-10 border-r border-slate-200 pl-8 shadow-sm">
                            <div class="font-medium text-slate-700 truncate" title="${p.name}">${p.name}</div>
                        </td>
                        <td class="px-2 py-2 text-center border-r border-slate-100">${qBadge}</td>
                `;

                // Render Cells for Each Hour
                for(let h=0; h<totalHoursInt; h++) {
                    let assignedDoc = null;
                    if (currentSchedule && currentSchedule[h]) {
                        const hourAssignments = currentSchedule[h];
                        Object.keys(hourAssignments).forEach(docName => {
                            if (hourAssignments[docName].some(t => t.patient.id === p.id)) {
                                assignedDoc = docName;
                            }
                        });
                    }

                    if (assignedDoc) {
                        const color = getDoctorColorClass(assignedDoc);
                        if (assignedDoc === "UNASSIGNED") {
                             detailHTML += `<td class="p-1 border-l border-slate-100"><div class="w-full h-full bg-red-100 text-red-600 text-[10px] flex items-center justify-center rounded font-bold" title="Unassigned">!</div></td>`;
                        } else {
                             const abbr = assignedDoc.substring(0, 3).toUpperCase();
                             detailHTML += `<td class="p-1 border-l border-slate-100"><div class="w-full py-1 ${color.bg} ${color.text} text-[10px] flex items-center justify-center rounded font-bold border border-black/5" title="${assignedDoc}">${abbr}</div></td>`;
                        }
                    } else {
                        detailHTML += `<td class="p-1 border-l border-slate-100 bg-slate-50/30"></td>`;
                    }
                }
                detailHTML += `</tr>`;
            });

            detailHTML += `</tbody></table>`;
            detailContainer.innerHTML = detailHTML;
        }

        function renderTimeline(assignment) {
            const container = document.getElementById('timelineContent');
            container.innerHTML = '';
            
            const sTimeStr = document.getElementById('startTime').value;
            const startHour = parseInt(sTimeStr.split(':')[0]);
            const startMin = sTimeStr.split(':')[1];
            
            if (!currentSchedule) return;

            currentSchedule.forEach((hourAssignments, i) => {
                let currentH = (startHour + i) % 24;
                let ampm = currentH >= 12 ? 'PM' : 'AM';
                let displayH = currentH % 12;
                if(displayH === 0) displayH = 12;
                
                const hourBlock = document.createElement('div');
                hourBlock.className = "pl-8 pb-8 relative";
                hourBlock.innerHTML = `
                    <div class="absolute left-[6px] top-1 w-5 h-5 bg-slate-400 rounded-full border-4 border-white z-10 shadow-sm"></div>
                    <h3 class="font-bold text-lg text-slate-700 mb-3">${displayH}:${startMin} ${ampm}</h3>
                `;

                if (Object.keys(hourAssignments).length === 0) {
                    hourBlock.innerHTML += `<div class="text-slate-400 italic text-sm">No standard checks due.</div>`;
                } else {
                    const grid = document.createElement('div');
                    grid.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3";
                    
                    Object.keys(hourAssignments).sort().forEach(docName => {
                        const assignedTasks = hourAssignments[docName];
                        let isUnassigned = (docName === "UNASSIGNED");
                        let cardClass = isUnassigned ? "bg-red-100 border-red-300" : "bg-slate-50 border-slate-200";
                        let headerColor = isUnassigned ? "text-red-700" : "text-slate-800";

                        // Group by Loc
                        let locGroups = {};
                        assignedTasks.forEach(t => {
                            let loc = t.patient.location || "Unspecified";
                            if(!locGroups[loc]) locGroups[loc] = [];
                            locGroups[loc].push(t);
                        });
                        
                        // Sort locations based on config order
                        let sortedLocs = Object.keys(locGroups).sort(locationNameComparator);

                        let innerHTML = '';
                        sortedLocs.forEach(locName => {
                            let locTasks = locGroups[locName];
                            
                            // Sort tasks within location
                            locTasks.sort((a,b) => {
                                const orderA = a.patient.entryOrder !== undefined ? a.patient.entryOrder : 99999;
                                const orderB = b.patient.entryOrder !== undefined ? b.patient.entryOrder : 99999;
                                return orderA - orderB;
                            });
                            
                            innerHTML += `
                                <div class="mb-2 last:mb-0">
                                    <div class="text-[10px] font-bold text-indigo-600 uppercase border-b border-indigo-100 mb-1">${locName}</div>
                                    ${locTasks.map(t => `
                                        <div class="flex justify-between items-center text-xs py-1 border-b border-slate-50 last:border-0">
                                            <div class="flex flex-col">
                                                <span class="text-slate-700 font-medium">${t.patient.name}</span>
                                                ${t.isCoverage ? `<span class="text-[9px] text-orange-600 font-bold">Covering (${t.primaryDoc.name})</span>` : ''}
                                                ${t.unassigned ? `<span class="text-[9px] text-red-600 font-bold">Primary: ${t.primaryDoc.name}</span>` : ''}
                                            </div>
                                            <span class="font-mono font-bold ${getQTextColor(t.patient.freq)}">Q${t.patient.freq}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        });

                        const docCard = document.createElement('div');
                        docCard.className = `${cardClass} border rounded p-3 shadow-sm`;
                        docCard.innerHTML = `
                            <div class="font-bold ${headerColor} text-sm mb-2 pb-1 border-b border-slate-200 flex justify-between">
                                <div>${docName} <span class="bg-white text-slate-600 text-xs px-2 rounded-full border">${assignedTasks.length}</span></div>
                            </div>
                            <div class="space-y-0.5">${innerHTML}</div>
                        `;
                        grid.appendChild(docCard);
                    });
                    hourBlock.appendChild(grid);
                }
                container.appendChild(hourBlock);
            });
        }

        // --- 6. UTILITIES & HELPERS ---

        function updateDuration() {
            const start = document.getElementById('startTime').value;
            const end = document.getElementById('endTime').value;
            q8Offset = parseInt(document.getElementById('q8Offset').value);
            q2Offset = parseInt(document.getElementById('q2Offset').value);
            q4Offset = parseInt(document.getElementById('q4Offset').value);

            let sMins = timeToMinutes(start);
            let eMins = timeToMinutes(end);
            
            if (eMins <= sMins) eMins += 24 * 60;
            const diffMins = eMins - sMins;
            shiftHours = diffMins / 60;
            
            document.getElementById('durationDisplay').innerText = `Duration: ${shiftHours.toFixed(1)} Hours`;

            // Helper to get formatted start time
            const getStartTime = (offset) => {
                let date = new Date(`01/01/2000 ${start}`);
                date.setHours(date.getHours() + offset);
                return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            };

            document.getElementById('q2StartTimeDisplay').innerText = `Starts at: ${getStartTime(q2Offset)}`;
            document.getElementById('q4StartTimeDisplay').innerText = `Starts at: ${getStartTime(q4Offset)}`;
            document.getElementById('q8StartTimeDisplay').innerText = `Starts at: ${getStartTime(q8Offset)}`;
        }

        function timeToMinutes(timeStr) {
            const parts = timeStr.split(':');
            return parseInt(parts[0]) * 60 + parseInt(parts[1]);
        }

        function normalizeToShift(tStr, shiftStartMins) {
            let tMins = timeToMinutes(tStr);
            if (tMins < shiftStartMins) tMins += 24 * 60;
            return tMins - shiftStartMins;
        }

        function isDoctorAvailableAtHour(doc, hourIndex) {
            if (!doc.ranges || doc.ranges.length === 0) return true;
            const shiftStartStr = document.getElementById('startTime').value;
            const shiftStartMins = timeToMinutes(shiftStartStr);
            const checkMinute = (hourIndex * 60) + 30; 

            for(let r of doc.ranges) {
                let startOffset = normalizeToShift(r.start, shiftStartMins);
                let endOffset = normalizeToShift(r.end, shiftStartMins);
                if (endOffset < startOffset) endOffset += 24*60; 
                if (checkMinute >= startOffset && checkMinute < endOffset) return true;
            }
            return false;
        }

        function getDoctorAvailableHours(doc) {
            if (!doc.ranges || doc.ranges.length === 0) return shiftHours;
            const shiftStartStr = document.getElementById('startTime').value;
            const shiftStartMins = timeToMinutes(shiftStartStr);
            let totalMins = 0;

            doc.ranges.forEach(r => {
                let startOffset = normalizeToShift(r.start, shiftStartMins);
                let endOffset = normalizeToShift(r.end, shiftStartMins);
                if (endOffset <= startOffset) endOffset += 24*60;
                totalMins += (endOffset - startOffset);
            });
            return totalMins / 60;
        }

        function isCheckDue(freq, hourIndex, patient = null) {
            let globalOffset = 0;
            if (freq === 8) globalOffset = q8Offset;
            else if (freq === 4) globalOffset = q4Offset;
            else if (freq === 2) globalOffset = q2Offset;
            
            // Apply Stagger if enabled
            let specificOffset = 0;
            const useStagger = document.getElementById('staggerToggle') && document.getElementById('staggerToggle').checked;
            if (useStagger && patient && patient.staggerOffset !== undefined) {
                specificOffset = patient.staggerOffset;
            }

            let totalOffset = (globalOffset + specificOffset) % freq;
            
            // Check if hour is before the start offset (unlikely given selectors, but good for safety)
            if (hourIndex < totalOffset) return false;
            
            // Check modulo
            return (hourIndex - totalOffset) % freq === 0;
        }

        function getCheckCountForDoc(patient, doc) {
            let count = 0;
            const totalHoursInt = Math.ceil(shiftHours);
            for (let h = 0; h < totalHoursInt; h++) {
                if (isCheckDue(patient.freq, h, patient) && isDoctorAvailableAtHour(doc, h)) {
                    count++;
                }
            }
            return count;
        }

        function getBurden(patient) {
            let count = 0;
            const totalHoursInt = Math.ceil(shiftHours);
            for (let h = 0; h < totalHoursInt; h++) {
                if (isCheckDue(patient.freq, h, patient)) {
                    count++;
                }
            }
            return count;
        }

        // Sorting Comparators
        function patientComparator(a, b) {
            const locIdxA = locations.findIndex(l => l.name === a.location);
            const locIdxB = locations.findIndex(l => l.name === b.location);
            
            const safeIdxA = locIdxA === -1 ? 999 : locIdxA;
            const safeIdxB = locIdxB === -1 ? 999 : locIdxB;

            if (safeIdxA !== safeIdxB) return safeIdxA - safeIdxB;
            return (a.entryOrder || 0) - (b.entryOrder || 0);
        }

        function locationNameComparator(a, b) {
            const idxA = locations.findIndex(l => l.name === a);
            const idxB = locations.findIndex(l => l.name === b);
            const safeIdxA = idxA === -1 ? 999 : idxA;
            const safeIdxB = idxB === -1 ? 999 : idxB;
            return safeIdxA - safeIdxB;
        }

        // Import / Export
        function toggleImportModal() {
            const modal = document.getElementById('importModal');
            modal.classList.toggle('hidden');
            modal.classList.toggle('flex');
            if(!modal.classList.contains('hidden')) {
                document.getElementById('importTextarea').focus();
            }
        }

        function loadConfiguration() {
            const text = document.getElementById('importTextarea').value;
            if(!text) return;

            try {
                // Reset State
                doctors = [];
                patients = [];
                locations = [];
                patientEntryCounter = 0;
                
                const lines = text.split('\n').map(l => l.trim());
                let currentSection = null;
                let currentQ = 0;

                for (let line of lines) {
                    if(!line) continue;
                    if (line.startsWith('Shift:')) {
                        const parts = line.match(/Shift: (.*) to (.*)/);
                        if(parts) {
                            document.getElementById('startTime').value = parts[1].trim();
                            document.getElementById('endTime').value = parts[2].trim();
                        }
                    } 
                    else if (line.startsWith('Q2 Offset:')) {
                        const parts = line.match(/\+(\d+)/);
                        if(parts) document.getElementById('q2Offset').value = parts[1];
                    }
                    else if (line.startsWith('Q4 Offset:')) {
                        const parts = line.match(/\+(\d+)/);
                        if(parts) document.getElementById('q4Offset').value = parts[1];
                    }
                    else if (line.startsWith('Q8 Offset:')) {
                        const parts = line.match(/\+(\d+)/);
                        if(parts) document.getElementById('q8Offset').value = parts[1];
                    }
                    else if (line.startsWith('DOCTORS')) { currentSection = 'doctors'; }
                    else if (line.startsWith('LOCATIONS')) { currentSection = 'locations'; }
                    else if (line.startsWith('PATIENT LIST')) { currentSection = 'patients'; }
                    else if (line.match(/^\[Q\d\]/)) { currentQ = parseInt(line.replace(/\D/g, '')); }
                    else if (line.startsWith('- ')) {
                        const content = line.substring(2).trim();
                        if (currentSection === 'doctors') {
                            const parts = content.match(/^(.*?)(\s\[(.*)\])?$/);
                            if (parts) {
                                const dName = parts[1].trim();
                                let dRanges = [];
                                if (parts[3]) {
                                    const rangesStr = parts[3].split(',');
                                    rangesStr.forEach(r => {
                                        const times = r.trim().split('-');
                                        if(times.length === 2) dRanges.push({start: times[0].trim(), end: times[1].trim()});
                                    });
                                }
                                doctors.push({ id: Date.now() + Math.random(), name: dName, ranges: dRanges });
                            }
                        }
                        else if (currentSection === 'locations') {
                            locations.push({ id: Date.now() + Math.random(), name: content });
                        }
                        else if (currentSection === 'patients' && currentQ > 0) {
                            const match = content.match(/^(.*?)(?:\s*\((.*)\))?$/);
                            if(match) {
                                const pName = match[1];
                                const details = match[2];
                                let pLoc = "";
                                let pPref = "";
                                if (details) {
                                    const detailParts = details.split(',').map(s => s.trim());
                                    detailParts.forEach(d => {
                                        if(d.startsWith('Pref:')) pPref = d.replace('Pref:', '').trim();
                                        else pLoc = d;
                                    });
                                }
                                patients.push({
                                    id: Date.now() + Math.random(),
                                    name: pName,
                                    freq: currentQ,
                                    location: pLoc,
                                    pref: pPref,
                                    staggerOffset: 0,
                                    entryOrder: patientEntryCounter++
                                });
                            }
                        }
                    }
                }

                // Enforce Standard Location Order
                const standardOrder = ['Aquarium', 'Left Peripheral', 'Left Central', 'Right Central', 'Right Peripheral', 'Isolation Room'];
                locations.sort((a,b) => {
                    let idxA = standardOrder.indexOf(a.name);
                    let idxB = standardOrder.indexOf(b.name);
                    if (idxA === -1) idxA = 999;
                    if (idxB === -1) idxB = 999;
                    if (idxA !== idxB) return idxA - idxB;
                    return a.name.localeCompare(b.name);
                });

                updateDuration();
                renderAll();
                toggleImportModal();
                showToast("Configuration Loaded!");
            } catch (e) {
                console.error(e);
                alert("Error parsing text. Please ensure it matches the 'Copy Inputs' format.");
            }
        }

        function copyInputs() {
            const start = document.getElementById('startTime').value;
            const end = document.getElementById('endTime').value;
            let text = `INPUT CONFIGURATION\n===================\n`;
            text += `Shift: ${start} to ${end}\n`;
            text += `Q2 Offset: +${q2Offset} Hours\n`;
            text += `Q4 Offset: +${q4Offset} Hours\n`;
            text += `Q8 Offset: +${q8Offset} Hours\n\nDOCTORS\n`;
            doctors.forEach(d => {
                let rangeStr = "";
                if(d.ranges.length > 0) rangeStr = " [" + d.ranges.map(r => `${r.start}-${r.end}`).join(', ') + "]";
                text += `- ${d.name}${rangeStr}\n`;
            });
            text += `\nLOCATIONS\n`;
            locations.forEach(l => text += `- ${l.name}\n`);
            text += `\nPATIENT LIST\n`;
            [1, 2, 4, 8].forEach(q => {
                const qPats = patients.filter(p => p.freq === q);
                if (qPats.length > 0) {
                    text += `\n[Q${q}]\n`;
                    qPats.forEach(p => {
                        let details = [];
                        if (p.location) details.push(p.location);
                        if (p.pref) details.push(`Pref: ${p.pref}`);
                        const detailStr = details.length > 0 ? ` (${details.join(', ')})` : '';
                        text += `- ${p.name}${detailStr}\n`;
                    });
                }
            });
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try { document.execCommand('copy'); showToast("Inputs copied to clipboard!"); } 
            catch (err) { console.error('Failed to copy', err); showToast("Failed to copy"); }
            document.body.removeChild(textarea);
        }

        function switchView(view) {
            currentView = view;
            const boxCard = document.getElementById('viewCardContainer');
            const boxTable = document.getElementById('viewTableContainer');
            const boxTime = document.getElementById('viewTimelineContainer');
            const btnCard = document.getElementById('btnViewCard');
            const btnTable = document.getElementById('btnViewTable');
            const btnTime = document.getElementById('btnViewTimeline');

            boxCard.classList.add('hidden'); boxTable.classList.add('hidden'); boxTime.classList.add('hidden');
            const activeClass = "px-4 py-1.5 rounded-md text-sm font-semibold shadow-sm bg-white text-slate-800 transition";
            const inactiveClass = "px-4 py-1.5 rounded-md text-sm font-semibold text-slate-600 hover:text-slate-800 transition";
            
            btnCard.className = inactiveClass; btnTable.className = inactiveClass; btnTime.className = inactiveClass;

            if (view === 'card') { boxCard.classList.remove('hidden'); btnCard.className = activeClass; }
            else if (view === 'table') { boxTable.classList.remove('hidden'); btnTable.className = activeClass; }
            else { boxTime.classList.remove('hidden'); btnTime.className = activeClass; }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.innerText = message;
            toast.className = "show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }

        function getQColor(freq) {
            if (freq === 1) return 'border-red-500';
            if (freq === 2) return 'border-orange-400';
            if (freq === 4) return 'border-blue-400';
            return 'border-green-400';
        }
        function getQTextColor(freq) {
            if (freq === 1) return 'text-red-600';
            if (freq === 2) return 'text-orange-500';
            if (freq === 4) return 'text-blue-500';
            return 'text-green-600';
        }
    </script>
</body>
</html>
